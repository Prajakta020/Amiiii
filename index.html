<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Access Gate & Castle Quest</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set default font and ensure full height */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling */
        }

        /* Custom Styles for the simple game */
        #game-screen {
            position: relative;
            width: 100%;
            height: 80vh; 
            max-width: 900px;
            margin: 0 auto;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            /* ENHANCEMENT: Sky Gradient */
            background: linear-gradient(to top, #93c5fd 0%, #3b82f6 100%); 
            overflow: hidden; /* This is the viewport */
        }

        #game-world {
            position: absolute;
            height: 100%;
            width: 2000px; /* The actual, wider game world */
            transition: transform 0.01s linear; /* Smooth scrolling effect */
        }

        #player {
            position: absolute;
            width: 50px; /* Updated width for image */
            height: 50px; /* Updated height for image */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 20; 
            transition: box-shadow 0.1s;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
        }

        #player-image {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Ensure the image fits within the bounds */
            image-rendering: optimizeQuality; /* Ensure high quality render */
        }
        
        #player-name-tag {
            background-color: white;
            color: black;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7em;
            margin-top: 2px;
            white-space: nowrap;
            position: absolute; 
            top: 100%; 
            transform: translateX(0%); 
            z-index: 21; 
        }
        
        .platform {
            position: absolute;
            /* ENHANCEMENT: Platform Gradient/Texture */
            background: linear-gradient(to top, #16a34a, #059669); /* Darker green gradient */
            box-shadow: 0 -4px 0 rgba(0, 0, 0, 0.2) inset; /* Simple shadow for depth */
            height: 20px;
            border-radius: 4px;
            z-index: 10;
        }

        /* Styling for the new moving platform */
        .moving-platform {
            background: linear-gradient(to right, #9333ea, #c084fc); /* Purple/Violet gradient */
            box-shadow: 0 -4px 0 rgba(0, 0, 0, 0.3) inset;
        }
        
        /* NEW: Spike Hazard Styling */
        .spike-hazard {
            position: absolute;
            width: 50px;
            height: 15px; /* Spike height */
            background-color: transparent;
            z-index: 15;
        }
        
        /* Create the triangular spike shape using CSS borders */
        .spike-hazard::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 15px solid #ef4444; /* Red color */
        }
        
        /* NEW: Key Collectable Styling */
        #key-collectable {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #fcd34d; /* Yellow/Gold */
            border: 3px solid #b45309; /* Dark border */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 18;
            animation: bounce 1s infinite alternate; /* Simple animation for visibility */
        }

        /* NEW: NPC Character Styling */
        .npc-character {
            position: absolute;
            width: 45px;
            height: 45px;
            background-color: #3b82f6; /* Blue for visibility */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 18;
            border: 3px solid white;
            cursor: pointer;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }

        #castle {
            position: absolute;
            width: 80px;
            height: 120px;
            background-color: #9ca3af; /* Gray castle base */
            border-top: 10px solid #ef4444; /* Red roof */
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            z-index: 10;
            /* ENHANCEMENT: Castle shadow */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        #key-status {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Mobile Controls Styling */
        .mobile-control-btn {
            @apply p-4 rounded-full text-white font-bold text-lg shadow-xl transition-all duration-100 ease-in-out;
            touch-action: manipulation; /* Prevents default mobile browser actions like zoom/scroll */
            user-select: none;
            flex-grow: 1;
        }

        .mobile-control-btn:active {
            @apply shadow-none transform scale-95;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1d4ed8', // Blue 700
                        'primary-dark': '#1e40af', // Blue 800
                        'accent-green': '#10b981', // Emerald 500
                        'accent-red': '#ef4444', // Red 500
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

    <!-- Main Application Container -->
    <div id="app" class="w-full h-full flex flex-col items-center">

        <!-- Initial state variable to track verification status -->
        <script>
            let isVerified = false;
        </script>

        <!-- 
            ####################################################################
            1. BIOMETRIC ACCESS GATE (Initial State)
            ####################################################################
        -->
        <div id="auth-gate" class="absolute inset-0 flex items-center justify-center bg-gray-900 transition-opacity duration-500 opacity-100">
            <div class="w-11/12 max-w-md bg-white p-8 rounded-xl shadow-2xl text-center transform scale-100 transition-all duration-300">
                
                <!-- Lock Icon -->
                <svg id="lock-icon" class="w-16 h-16 text-primary mx-auto mb-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>

                <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Secure Access Required</h1>
                <p class="text-gray-500 mb-6">Please verify your identity using biometric authentication to proceed.</p>

                <!-- Status Message Area -->
                <div id="status-message" class="h-6 mb-6 text-sm font-medium text-primary">Awaiting verification...</div>

                <!-- Action Button -->
                <button 
                    id="verify-button"
                    onclick="authenticateBiometrics()"
                    class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-primary focus:ring-opacity-50 disabled:opacity-50"
                >
                    Start Biometric Scan
                </button>
                
                <p class="text-xs text-gray-400 mt-4">Note: This is a simulated process for demonstration purposes.</p>
            </div>
        </div>

        <!-- 
            ####################################################################
            2. MAIN CONTENT - CASTLE QUEST GAME
            ####################################################################
        -->
        <div id="main-content" class="w-full h-full hidden p-4 sm:p-8 overflow-y-auto flex flex-col items-center justify-center">
            <h1 id="game-title" class="text-xl sm:text-3xl font-bold text-gray-800 mb-2 sm:mb-4 transition-colors duration-500 text-center">
                Welcome, Ami! Reach the Castle.
            </h1>
            
            <div id="game-screen">
                <div id="game-world">
                    <!-- Game Elements -->
                    <div id="player">
                        <!-- Custom Image for the Player -->
                        <img id="player-image" src="Screenshot 2025-11-08 215152.png" alt="Player Character" onerror="this.onerror=null; this.src='https://placehold.co/50x50/1d4ed8/ffffff?text=P';" />
                        <div id="player-name-tag">Amiiiii</div>
                    </div>

                    <div id="castle" style="right: 50px; bottom: 0;">üè∞</div>
                    
                    <!-- NEW NPC CHARACTERS -->
                    <div class="npc-character" id="npc-1" style="left: 150px; bottom: 60px;">üòä</div>
                    <div class="npc-character" id="npc-2" style="left: 750px; bottom: 160px;">‚ú®</div>
                    <div class="npc-character" id="npc-3" style="left: 1300px; bottom: 220px;">üí™</div>
                    
                    <!-- Platforms and Hazards (Positions are absolute within the 2000px game-world) -->
                    
                    <!-- 1. Start Platform (0px - 300px) -->
                    <div class="platform" style="left: 0px; width: 300px; bottom: 0;"></div> 
                    <div class="spike-hazard" style="left: 300px; bottom: 20px;"></div>
                    
                    <!-- 2. Gap Jump 1 (400px - 550px) -->
                    <div class="platform" style="left: 400px; width: 150px; bottom: 60px;"></div> 
                    <div class="spike-hazard" style="left: 550px; bottom: 20px;"></div>
                    
                    <!-- 3. High Jump (700px - 800px) -->
                    <div class="platform" style="left: 700px; width: 100px; bottom: 120px;"></div> 

                    <!-- 4. Key Platform (900px - 1050px) -->
                    <div class="platform" style="left: 900px; width: 150px; bottom: 60px;"></div>
                    <div id="key-collectable" style="left: 950px; bottom: 90px;">üîë</div>
                    <div class="spike-hazard" style="left: 1050px; bottom: 20px;"></div>

                    <!-- 5. Moving Platform Section (1200px - 1500px range) -->
                    <div class="platform moving-platform" id="moving-platform" style="left: 1200px; width: 150px; bottom: 180px;"></div> 
                    <div class="spike-hazard" style="left: 1200px; bottom: 20px;"></div>
                    <div class="spike-hazard" style="left: 1350px; bottom: 20px;"></div>
                    <div class="spike-hazard" style="left: 1500px; bottom: 20px;"></div>

                    <!-- 6. Final Series of Jumps (1600px - 1800px) -->
                    <div class="platform" style="left: 1600px; width: 100px; bottom: 60px;"></div>
                    <div class="platform" style="left: 1750px; width: 100px; bottom: 120px;"></div>
                    
                    <!-- 7. Final Castle Approach (1900px) -->
                    <div class="platform" style="left: 1900px; width: 100px; bottom: 0;"></div>
                    
                </div>
            </div>

            <!-- Game Controls and Status Area -->
            <div class="w-full max-w-md mt-4 flex flex-col gap-3">
                
                <!-- Key Status (Always visible) -->
                <div id="key-status" class="p-2 border border-gray-300 rounded-lg bg-gray-50 flex justify-center w-full">
                    <span class="text-gray-700 font-semibold mr-2">Key Status:</span>
                    <span id="key-text" class="text-accent-red font-bold">NOT FOUND üî¥</span>
                </div>

                <!-- Desktop Controls (Hidden on Mobile) -->
                <div id="desktop-controls" class="hidden sm:block p-3 bg-white rounded-lg shadow-md text-center">
                    <p class="font-semibold text-gray-700 mb-1">Keyboard Controls:</p>
                    <p class="text-sm text-gray-500">Move: <span class="font-mono bg-gray-200 p-1 rounded">A/D</span> or <span class="font-mono bg-gray-200 p-1 rounded">&larr;/&rarr;</span> | Jump: <span class="font-mono bg-gray-200 p-1 rounded">Space</span></p>
                </div>

                <!-- Mobile Touch Controls (Visible on Mobile) -->
                <div id="mobile-controls" class="sm:hidden flex justify-between gap-2 p-2 bg-white rounded-lg shadow-lg">
                    <button 
                        id="btn-left" 
                        class="mobile-control-btn bg-blue-500 hover:bg-blue-600 active:bg-blue-700 w-1/3"
                        ontouchstart="handleTouchStart(event, 'a')" 
                        ontouchend="handleTouchEnd(event, 'a')" 
                        onmousedown="handleTouchStart(event, 'a')"
                        onmouseup="handleTouchEnd(event, 'a')"
                    >
                        &larr;
                    </button>
                    <button 
                        id="btn-jump" 
                        class="mobile-control-btn bg-red-500 hover:bg-red-600 active:bg-red-700 w-1/3"
                        ontouchstart="handleTouchStart(event, ' ')" 
                        ontouchend="handleTouchEnd(event, ' ')"
                        onmousedown="handleTouchStart(event, ' ')"
                        onmouseup="handleTouchEnd(event, ' ')"
                    >
                        JUMP
                    </button>
                    <button 
                        id="btn-right" 
                        class="mobile-control-btn bg-blue-500 hover:bg-blue-600 active:bg-blue-700 w-1/3"
                        ontouchstart="handleTouchStart(event, 'd')" 
                        ontouchend="handleTouchEnd(event, 'd')"
                        onmousedown="handleTouchStart(event, 'd')"
                        onmouseup="handleTouchEnd(event, 'd')"
                    >
                        &rarr;
                    </button>
                </div>
            </div>

            <!-- Message Box (used for win/lose messages) -->
            <div id="message-box" class="fixed top-0 left-1/2 -translate-x-1/2 p-4 hidden"></div>
        </div>
<!-- 
            ####################################################################
            1. BIOMETRIC ACCESS GATE (Initial State)
            ####################################################################
        --><div id="victory-gate" class="absolute inset-0 flex items-center justify-center bg-gray-900 transition-opacity duration-500 opacity-100 hidden">
            <div class="w-11/12 max-w-md bg-white p-8 rounded-xl shadow-2xl text-center transform scale-100 transition-all duration-300">
                
                
                <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Well Done Amiiiii</h1>
                <p class="text-gray-500 mb-6">hey, just saying ‚Äî you‚Äôre genuinely such a good person. like not just a good friend, but actually a good human. you make things lighter, funnier, and somehow calmer all at once. it‚Äôs rare to find someone like you, and i hope you know how precious you are (Aur ha bhai tum khudki hi nahi sabki favourite ho!)</p>

     

                
            </div>
        </div>
        <!-- 
            ####################################################################
            3. JAVASCRIPT LOGIC (Biometric and Game)
            ####################################################################
        -->
        <script>
            // Biometric Auth Elements
            const authGate = document.getElementById('auth-gate');
            const mainContent = document.getElementById('main-content');
            const verifyButton = document.getElementById('verify-button');
            const statusMessage = document.getElementById('status-message');
            const lockIcon = document.getElementById('lock-icon');
            
            // Game Elements
            const playerEl = document.getElementById('player');
            const castleEl = document.getElementById('castle');
            const gameScreenEl = document.getElementById('game-screen');
            const gameWorldEl = document.getElementById('game-world');
            const gameTitleEl = document.getElementById('game-title');
            const platformEls = document.querySelectorAll('.platform');
            const hazardEls = document.querySelectorAll('.spike-hazard'); 
            const keyEl = document.getElementById('key-collectable');      
            const keyStatusEl = document.getElementById('key-text');      
            const messageBoxEl = document.getElementById('message-box');
            const movingPlatformEl = document.getElementById('moving-platform');
            const npcEls = document.querySelectorAll('.npc-character'); 

            // --- Biometric Authentication Logic ---
            
            function updateGateState(iconColor, statusText, statusColor) {
                lockIcon.classList.remove('text-primary', 'text-accent-green', 'text-accent-red');
                lockIcon.classList.add(iconColor);
                statusMessage.textContent = statusText;
                statusMessage.classList.remove('text-primary', 'text-accent-green', 'text-accent-red');
                statusMessage.classList.add(statusColor);
            }

            function authenticateBiometrics() {
                verifyButton.disabled = true;
                verifyButton.textContent = "Scanning Biometric Data...";
                updateGateState('text-primary', 'Scanning in progress...', 'text-primary');

                // Simulation: Wait 2 seconds for the "scan"
                setTimeout(() => {
                    const success = true; // Always succeed for this example
                    if (success) {
                        handleVerificationSuccess();
                    } else {
                        // This case is currently unreachable but kept for completeness
                        handleVerificationFailure();
                    }
                }, 2000); 
            }

            function handleVerificationSuccess() {
                isVerified = true;
                verifyButton.textContent = "Verification Successful";
                updateGateState('text-accent-green', 'Authentication successful! Starting quest...', 'text-accent-green');
                lockIcon.classList.add('scale-125');

                setTimeout(() => {
                    // Hide the gate and show the game
                    authGate.classList.remove('opacity-100');
                    authGate.classList.add('opacity-0', 'pointer-events-none');

                    setTimeout(() => {
                        authGate.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        
                        // Start the game loop after transition
                        gameStart();

                    }, 500); 
                }, 1000); 
            }

            function handleVerificationFailure() {
                verifyButton.textContent = "Try Again";
                updateGateState('text-accent-red', 'Verification failed. Access Denied.', 'text-accent-red');

                setTimeout(() => {
                    verifyButton.disabled = false;
                    updateGateState('text-primary', 'Awaiting verification...', 'text-primary');
                }, 1000);
            }
            
            // --- Game Logic Constants and Variables ---
            
            let GAME_SCREEN_WIDTH = 900;
            const GAME_WORLD_WIDTH = 2000;
            const GROUND_HEIGHT = 20;
            const SPIKE_HEIGHT = 15;
            
            // Player state - UPDATED DIMENSIONS
            let player = {
                x: 50,
                y: GROUND_HEIGHT, 
                vx: 0,
                vy: 0,
                width: 50, // Updated width for image
                height: 50, // Updated height for image
                isOnGround: false,
                isJumping: false,
                hasKey: false 
            };

            // Physics constants
            const gravity = -0.6; 
            const jumpStrength = 13; 
            const moveSpeed = 5;
            
            // Input/Game State
            let keys = {};
            let isGameOver = false;
            let platforms = [];
            let hazards = []; 
            let keyObject = {}; 
            let npcs = []; 
            
            // Moving platform state
            let movingPlatform = {};
            const MOVING_PLATFORM_SPEED = 2;
            const MOVING_PLATFORM_MIN_X = 1200;
            const MOVING_PLATFORM_MAX_X = 1500;
            let cameraOffset = 0;


            // --- Core Game Functions (Moved for Hoisting/Referencing Fix) ---

            function gameLoop() {
                // Update screen width for camera calculations
                const gameRect = gameScreenEl.getBoundingClientRect();
                GAME_SCREEN_WIDTH = gameRect.width;

                gameUpdate();
            }

            function gameUpdate() {
                if (isGameOver) return;

                const prevX = player.x;
                const prevY = player.y;

                // --- Input Handling ---
                player.vx = 0;
                if (keys['a'] || keys['arrowleft']) {
                    player.vx = -moveSpeed;
                }
                if (keys['d'] || keys['arrowright']) {
                    player.vx = moveSpeed;
                }
                if (keys[' '] && player.isOnGround) {
                    player.vy = jumpStrength;
                    player.isJumping = true;
                    player.isOnGround = false;
                    playerEl.style.boxShadow = '0 0 10px 5px rgba(249, 115, 22, 0.6)'; // Enhanced shadow for jumping
                }

                // --- Moving Platform Update ---
                updateMovingPlatform();

                // --- Physics & Movement ---
                player.x += player.vx;
                player.y += player.vy;
                player.vy += gravity;

                // Simple Boundary Check (left/right walls of the world)
                if (player.x < 0) player.x = 0;
                if (player.x + player.width > GAME_WORLD_WIDTH) player.x = GAME_WORLD_WIDTH - player.width;
                
                // --- Collision Detection ---
                resolvePlatformCollisions(prevX, prevY);
                checkKeyCollision();
                checkHazardCollision();
                checkNPCCollision(); // Check for NPC interaction


                // --- Win Condition (Castle Collision) ---
                const castleRect = {
                    x: GAME_WORLD_WIDTH - 80, // Castle width is 80
                    y: 0, 
                    w: 80,
                    h: 120
                };

                if (checkAABB(player, castleRect)) {
                    // Check for key before winning
                    if (player.hasKey) {
                        gameOver(true);
                    } else {
                        showMessage("The castle is locked! You need to find the Golden Key. üîë", false);
                    }
                }

                // --- Render Update ---
                playerEl.style.left = player.x + 'px';
                playerEl.style.bottom = player.y + 'px';
                
                updateCamera(); // Scroll the camera to keep the player in view
                
                requestAnimationFrame(gameLoop);
            }

            // --- Helper Functions (defined before gameStart) ---
            
            function showMessage(text, isWin) {
                messageBoxEl.textContent = text;
                messageBoxEl.className = 'fixed top-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white font-bold shadow-lg z-50 transition-all duration-300';
                messageBoxEl.classList.remove('hidden');
                
                // Use a neutral/motivating color for NPC messages
                if (isWin) {
                    messageBoxEl.classList.add('bg-accent-green');
                    gameTitleEl.classList.add('text-accent-green');
                } else if (text.includes('Spikes') || text.includes('locked') || text.includes('Bonk')) {
                    messageBoxEl.classList.add('bg-accent-red');
                } else {
                    // Default color for motivating/key messages
                    messageBoxEl.classList.add('bg-primary');
                }

                setTimeout(() => {
                    messageBoxEl.classList.add('hidden');
                }, 4000);
            }

            function resetPlayer() {
                player.x = 50;
                player.y = GROUND_HEIGHT;
                player.vy = 0;
                player.vx = 0;
                player.isOnGround = true;
                player.isJumping = false;
                player.hasKey = false; // Reset key on death
                
                // Reset key visual state
                keyEl.classList.remove('hidden');
                keyStatusEl.textContent = "NOT FOUND üî¥";
                keyStatusEl.classList.remove('text-accent-green');
                keyStatusEl.classList.add('text-accent-red');
                
                // Reset shadow 
                playerEl.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)';

                // Reset NPCs (make them visible again)
                npcs.forEach(npc => {
                    if (npc.el.classList.contains('hidden')) {
                        npc.el.classList.remove('hidden');
                        npc.read = false;
                    }
                });
            }

            // Helper for simple AABB collision detection
            function checkAABB(objA, objB) {
                return (
                    objA.x < objB.x + objB.w &&
                    objA.x + objA.width > objB.x &&
                    objA.y < objB.y + objB.h &&
                    objA.y + objA.height > objB.y
                );
            }
            
            function checkKeyCollision() {
                if (player.hasKey || keyEl.classList.contains('hidden')) return;

                if (checkAABB(player, keyObject)) {
                    player.hasKey = true;
                    keyEl.classList.add('hidden'); // Hide key visually
                    keyStatusEl.textContent = "KEY FOUND! üü¢";
                    keyStatusEl.classList.remove('text-accent-red');
                    keyStatusEl.classList.add('text-accent-green');
                    showMessage("Golden Key collected! Now hurry to the Castle! üîë", true);
                }
            }

            function checkHazardCollision() {
                hazards.forEach(h => {
                    if (checkAABB(player, h)) {
                        showMessage("Ouch! Spikes encountered. Resetting...", false);
                        resetPlayer();
                    }
                });
            }

            // NPC Collision Check
            function checkNPCCollision() {
                npcs.forEach(npc => {
                    if (!npc.read && checkAABB(player, npc)) {
                        showMessage(npc.message, false); // Show the motivational message
                        npc.read = true; // Mark as read
                        npc.el.classList.add('hidden'); // Hide the NPC after interaction
                    }
                });
            }


            function updateMovingPlatform() {
                // Determine the platform's next position
                let nextX = movingPlatform.x + movingPlatform.dx;

                if (nextX > MOVING_PLATFORM_MAX_X) {
                    movingPlatform.dx = -MOVING_PLATFORM_SPEED;
                    nextX = MOVING_PLATFORM_MAX_X;
                } else if (nextX < MOVING_PLATFORM_MIN_X) {
                    movingPlatform.dx = MOVING_PLATFORM_SPEED;
                    nextX = MOVING_PLATFORM_MIN_X;
                }
                
                movingPlatform.x = nextX;
                movingPlatformEl.style.left = movingPlatform.x + 'px';
            }

            function resolvePlatformCollisions(prevX, prevY) {
                const playerRight = player.x + player.width;
                const playerTop = player.y + player.height;
                const prevRight = prevX + player.width;
                const prevTop = prevY + player.height;

                player.isOnGround = false;

                platforms.forEach(p => {
                    const platformRight = p.x + p.w;
                    const platformTop = p.y + p.h;

                    if (
                        player.x < platformRight && playerRight > p.x &&
                        player.y < platformTop && playerTop > p.y
                    ) {
                        
                        // 1. Hit from TOP (Landing)
                        if (player.vy <= 0 && prevY >= platformTop) {
                            player.y = platformTop; 
                            player.vy = 0;
                            player.isOnGround = true;
                            player.isJumping = false;
                            playerEl.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)'; // Reset shadow on land

                            // If on the moving platform, carry the player with it
                            if (p.el === movingPlatformEl) {
                                player.x += movingPlatform.dx;
                            }
                        } 
                        
                        // 2. Hit from BOTTOM (Bonked Head)
                        else if (player.vy > 0 && prevTop <= p.y) {
                            player.y = p.y - player.height; 
                            player.vy = gravity; 
                            player.isJumping = false;
                            showMessage("Bonk! Watch your head.", false);
                        }

                        // 3. Hit from LEFT or RIGHT (Horizontal) - only resolve if not grounding
                        else if (!player.isOnGround) {
                            // Hit from Left
                            if (prevRight <= p.x) {
                                player.x = p.x - player.width;
                                player.vx = 0;
                            } 
                            // Hit from Right
                            else if (prevX >= platformRight) {
                                player.x = platformRight;
                                player.vx = 0;
                            }
                        }
                    }
                });

                // --- CRITICAL BOUNDARY CHECK: Prevent falling off the bottom
                if (player.y < GROUND_HEIGHT) {
                    if (player.vy <= 0) { 
                        player.y = GROUND_HEIGHT;
                        player.vy = 0;
                        player.isOnGround = true;
                        player.isJumping = false;
                        playerEl.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)'; // Reset shadow on ground
                    }
                    // Fall off the screen (death simulation)
                    if (player.y < -50) { 
                        showMessage("Fell into the abyss! Resetting...", false);
                        resetPlayer();
                    }
                }
            }

            function updateCamera() {
                // Update screen width for camera calculations dynamically
                const gameRect = gameScreenEl.getBoundingClientRect();
                GAME_SCREEN_WIDTH = gameRect.width;

                // Calculate the desired center point of the viewport (e.g., 40% from the left)
                const centerPoint = GAME_SCREEN_WIDTH * 0.4;
                
                // Calculate the amount of scrolling needed
                let targetOffset = player.x - centerPoint;

                // Clamp the offset to keep the camera within the game world bounds
                const maxOffset = GAME_WORLD_WIDTH - GAME_SCREEN_WIDTH;
                
                // Ensure the camera doesn't show blank space on the left
                if (targetOffset < 0) {
                    targetOffset = 0;
                }
                
                // Ensure the camera doesn't show blank space on the right (if the world is wider than the screen)
                if (maxOffset > 0 && targetOffset > maxOffset) {
                    targetOffset = maxOffset;
                } else if (maxOffset <= 0) {
                    // If the screen is wider than the world, keep offset at 0
                    targetOffset = 0;
                }

                cameraOffset = targetOffset;
                gameWorldEl.style.transform = `translateX(-${cameraOffset}px)`;
            }

            function gameOver(won) {
                isGameOver = true;
                const victory = document.getElementById('victory-gate');

                playerEl.style.boxShadow = won ? '0 0 15px 5px #10b981' : '0 0 15px 5px #ef4444';
                if (won) {
                    gameTitleEl.textContent = "üëë Access Complete! You Reached the Castle!";
                    showMessage("Victory! Access Complete and Castle Reached!", true);
                    mainContent.classList.add('hidden');
                    victory.classList.remove('hidden');
                }
                document.removeEventListener('keydown', handleKeyDown);
                document.removeEventListener('keyup', handleKeyUp);
            }


            // Initialization
            function gameStart() {
                // Initial player placement
                playerEl.style.left = player.x + 'px';
                playerEl.style.bottom = player.y + 'px';
                player.vy = 0; 
                
                // Initialize platforms and hazards for collision detection
                platforms = [];
                // Collect all static platforms
                document.querySelectorAll('.platform:not(.moving-platform)').forEach(el => {
                    platforms.push({ 
                        el, 
                        x: parseFloat(el.style.left), 
                        y: parseFloat(el.style.bottom), 
                        w: parseFloat(el.style.width), 
                        h: 20 
                    });
                });
                
                // Collect moving platform and set its initial state
                movingPlatform = {
                    el: movingPlatformEl,
                    x: parseFloat(movingPlatformEl.style.left),
                    y: parseFloat(movingPlatformEl.style.bottom),
                    w: parseFloat(movingPlatformEl.style.width),
                    h: 20,
                    dx: MOVING_PLATFORM_SPEED 
                };
                platforms.push(movingPlatform); // Add the moving platform to the collision array


                // Hazards and Key use their initial style positioning
                hazardEls.forEach(el => hazards.push({ 
                    el, 
                    x: parseFloat(el.style.left), 
                    y: parseFloat(el.style.bottom), 
                    w: 50, 
                    h: SPIKE_HEIGHT 
                }));
                keyObject = { 
                    el: keyEl, 
                    x: parseFloat(keyEl.style.left), 
                    y: parseFloat(keyEl.style.bottom), 
                    w: 30, 
                    h: 30 
                };

                // Initialize NPC characters
                const npcData = [
                    { id: 'npc-1', x: 150, y: 60, w: 45, h: 45, message: "Welcome to your special quest! You've already verified access, so the hardest part is over. You got this!" },
                    { id: 'npc-2', x: 750, y: 160, w: 45, h: 45, message: "Hello! The path ahead requires courage... and a certain shiny object! Look for it to unlock the final gate." },
                    { id: 'npc-3', x: 1300, y: 220, w: 45, h: 45, message: "Patience is key to timing tricky jumps. Remember how awesome you are, and you'll cross this moving platform in no time!" },
                ];

                npcs = npcData.map(data => {
                    const el = document.getElementById(data.id);
                    return {
                        el,
                        x: data.x,
                        y: data.y,
                        w: data.w,
                        h: data.h,
                        message: data.message,
                        read: false
                    };
                });


                // Setup Event Listeners
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('keyup', handleKeyUp);
                
                // Start the loop
                gameLoop();
            }
            
            // --- Input Handlers (defined last) ---
            
            function handleKeyDown(e) {
                keys[e.key.toLowerCase()] = true;
                if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    e.preventDefault(); // Prevent spacebar and arrows from scrolling the whole page
                }
            }

            function handleKeyUp(e) {
                keys[e.key.toLowerCase()] = false;
                if (e.key === ' ' && player.isJumping) {
                    // Slight cut of jump height if spacebar is released early
                    if (player.vy > jumpStrength / 2) {
                         player.vy = jumpStrength / 2;
                    }
                }
            }
            
            // --- Mobile Touch Handlers ---
            function handleTouchStart(e, key) {
                e.preventDefault(); 
                keys[key] = true;
            }

            function handleTouchEnd(e, key) {
                e.preventDefault(); 
                keys[key] = false;
            }

        </script>

    </div>

</body>
</html>
